@using BeamOs.CodeGen.EditorApi
@using BeamOs.CodeGen.StructuralAnalysisApiClient
@using BeamOs.StructuralAnalysis.Contracts.PhysicalModel.Models
@using MudBlazor

@inherits FluxorComponent

@if (proposalInfos is null)
{
    <MudPaper Class="flex flex-col items-center justify-center h-32 w-full">
        <MudProgressCircular Indeterminate Color="Color.Primary" Size="Size.Large" />
        <MudText Class="mt-2" Typo="Typo.h6">Loading proposals...</MudText>
    </MudPaper>
}
else
{
    @if (selectedProposal is null)
    {
        <MudPaper Class="p-3 w-full max-w-xs">
            <MudText Typo="Typo.h6" Class="mb-2">Proposals</MudText>
            <MudList T="ModelProposalInfo" Class="w-full">
                @foreach (var proposal in proposalInfos)
                {
                    <MudListItem Value="@proposal">
                        <div class="flex flex-row">
                            <div class="flex-1 flex flex-col">
                                <MudText Class="font-semibold">@proposal.Description</MudText>
                                <MudText Class="text-xs text-gray-500">@GetRelativeTime(proposal.LastModified)</MudText>
                            </div>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small"
                                OnClick="() => LoadProposal(proposal.Id)">View</MudButton>
                        </div>
                    </MudListItem>
                }
            </MudList>
        </MudPaper>
    }
    else
    {
        <MudPaper Class="p-3 w-full max-w-xs flex flex-col gap-4">
            <MudTooltip Text="Back">
                <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" OnClick="() => selectedProposal = null"></MudIconButton>
            </MudTooltip>
            <MudText Typo="Typo.h6">Proposal Details</MudText>
            <MudText Class="truncate"><span class="font-semibold">ID:</span> @selectedProposal.Id</MudText>
            <MudText Class="truncate"><span class="font-semibold">Last Modified:</span> @selectedProposal.LastModified</MudText>
            <MudText Class="truncate"><span class="font-semibold">Description:</span>
                @selectedProposal.ModelProposal?.Description</MudText>
            <div class="flex gap-2 mt-2">
                <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Small"
                    OnClick="() => AcceptProposal(selectedProposal.Id)">Accept</MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Error" Size="Size.Small"
                    OnClick="() => RejectProposal(selectedProposal.Id)">Reject</MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Default" Size="Size.Small"
                    OnClick="() => selectedProposal = null">Back</MudButton>
            </div>
            <MudDivider />
            <div class="flex items-center mb-2">
                <MudCheckBox Value="true" Color="Color.Primary" />
                <MudText Class="ml-2">Select All</MudText>
            </div>
            <MudList T="ProposalIssue" Class="divide-y divide-gray-200">
                @foreach (var proposalObject in this.ProposalObjects)
                {
                    <MudListItem Value="@proposalObject">
                        <div class="flex flex-row items-center gap-2 py-1">
                        <MudCheckBox Value="@selectedProposalObjectIds.Contains(proposalObject.Id.ToString())"
                                     Color="Color.Primary"
                                     ValueChanged="(bool checkedVal) => ToggleProposalObjectSelection(proposalObject.Id.ToString(), checkedVal)" />
                        <div class="flex flex-col gap-1">
                            <MudText Class="truncate"><span class="font-semibold">Object Type:</span> @proposalObject.ObjectType</MudText>
                            <MudText Class="truncate"><span class="font-semibold">Modification Type:</span> @proposalObject.ProposalType</MudText>
                        </div>
                        </div>
                    </MudListItem>
                }
            </MudList>
            @if (selectedProposal.ProposalIssues is not null && selectedProposal.ProposalIssues.Count > 0)
            {
                <MudSelect @bind-Value="minSeverity" Label="Minimum Severity" Dense="true" Class="mb-2 w-full">
                    @foreach (var sev in availableSeverities)
                    {
                        <MudSelectItem Value="@sev">@sev</MudSelectItem>
                    }
                </MudSelect>

                if (this.FilteredIssues.Any())
                {
                    <MudList T="ProposalIssue" Class="divide-y divide-gray-200">
                        @foreach (var issue in this.FilteredIssues)
                        {
                            <MudListItem Value="@issue" Class="flex flex-col gap-1 py-1">
                                <div class="flex flex-col">
                                    <MudText Class="truncate"><span class="font-semibold">ID:</span> @issue.ProposedId.ProposedId</MudText>
                                    <MudText Class="truncate"><span class="font-semibold">Object Type:</span> @issue.ObjectType</MudText>
                                    <MudText><span class="font-semibold">Message:</span> @issue.Message</MudText>
                                    <MudText Class="truncate"><span class="font-semibold">Severity:</span> @issue.Severity</MudText>
                                    @* <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                                        OnClick="() => ResolveIssue(issue)" Class="self-end mt-1">Resolve</MudButton> *@
                                </div>
                            </MudListItem>
                        }
                    </MudList>
                }
                else
                {
                    <MudText>No issues found for this severity.</MudText>
                }
            }
            else
            {
                <MudText>No issues found for this proposal.</MudText>
            }
        </MudPaper>
    }
}

@code {
    // ...existing code...
    // For checkbox selection
    private HashSet<string> selectedProposalObjectIds = new();
    private bool selectAllProposalObjects
    {
        get => ProposalObjects != null && ProposalObjects.Count > 0 && selectedProposalObjectIds.Count == ProposalObjects.Count;
        set
        {
            if (ProposalObjects == null) return;
            if (value)
                selectedProposalObjectIds = ProposalObjects.Select(x => x.Id.ToString()).ToHashSet();
            else
                selectedProposalObjectIds.Clear();
        }
    }
    private void ToggleProposalObjectSelection(string id, bool isChecked)
    {
        if (isChecked == true)
            selectedProposalObjectIds.Add(id);
        else
            selectedProposalObjectIds.Remove(id);
    }
}


