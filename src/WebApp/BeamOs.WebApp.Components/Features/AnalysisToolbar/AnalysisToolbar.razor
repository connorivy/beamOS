@using BeamOs.CodeGen.SpeckleConnectorApi
@using BeamOs.CodeGen.StructuralAnalysisApiClient
@using BeamOs.StructuralAnalysis.Contracts.Common
@using BeamOs.StructuralAnalysis.Contracts.PhysicalModel.Models
@using BeamOs.StructuralAnalysis.CsSdk
@using BeamOs.WebApp.Components.Features.Common
@using BeamOs.WebApp.Components.Features.Dialogs
@using BeamOs.WebApp.Components.Features.Editor
@using static BeamOs.WebApp.Components.Features.Dialogs.ReceiveFromSpeckleDialog

@inherits FluxorComponent

<MudPaper Class="@Class">
    <MudToolBar>
        @if (this.state.Value.IsCalculating)
        {
            <MudProgressCircular Color="Color.Default" Indeterminate="true" />
        }
        else if (this.editorState.Value.HasResults)
        {
            <MudTooltip Text="Unlock Model">
                <MudIconButton OnClick="UnlockModel" Icon="@Icons.Material.Outlined.Lock" Color="Color.Inherit" Class="">
                    Unlock Model</MudIconButton>
            </MudTooltip>
        }
        else
        {
            <MudTooltip Text="Run Analysis">
                <MudIconButton OnClick="RunAnalysis" Icon="@Icons.Material.Outlined.Calculate" Color="Color.Inherit"
                    Class="">Run Analysis</MudIconButton>
            </MudTooltip>
        }
        <MudTooltip Text="Show Diagrams">
            <MudMenu Icon="@Icons.Material.Outlined.AreaChart">
                <MudMenuItem OnClick="@editorComponent.ShowShear">Shear Diagrams</MudMenuItem>
                <MudMenuItem OnClick="@editorComponent.ShowMoment">Moment Diagrams</MudMenuItem>
                <MudMenuItem OnClick="@editorComponent.ShowDeflection">Deflection Diagrams</MudMenuItem>
            </MudMenu>
        </MudTooltip>
        <MudTooltip Text="Get Model Proposals">
            <MudIconButton OnClick="GetModelProposals" Icon="@Icons.Material.Outlined.Refresh" Color="Color.Inherit"
                Class="">Get Model Proposals</MudIconButton>
        </MudTooltip>

        <MudTooltip Text="Show Model Proposal">
            <MudSelect T="int" Label="Model Proposals" Color="Color.Inherit" Value="this.selectedModelProposalId"
                ValueChanged="DisplayModelProposal">
                <MudSelectItem Value="0">0</MudSelectItem>
                @foreach (var proposal in modelProposals)
                {
                    <MudSelectItem Value="@proposal.Id">@proposal.Id</MudSelectItem>
                }
            </MudSelect>
        </MudTooltip>

        <MudTooltip Text="Accept Model Proposal">
            <MudIconButton OnClick="AcceptModelProposal" Icon="@Icons.Material.Outlined.Check" Color="Color.Inherit"
                Class="">Accept Model Proposal</MudIconButton>
        </MudTooltip>
        <MudTooltip Text="Reject Model Proposal">
            <MudIconButton OnClick="RejectModelProposal" Icon="@Icons.Material.Outlined.Close" Color="Color.Inherit"
                Class="">Reject Model Proposal</MudIconButton>
        </MudTooltip>
        <MudTooltip Text="Recieve Date From Speckle">
            <MudIconButton OnClick="ReceiveFromSpeckle" Icon="@Icons.Material.Filled.CallReceived" />
        </MudTooltip>
    </MudToolBar>
</MudPaper>

@code {
    [Parameter]
    public string? Class { get; init; }

    [Parameter]
    public EditorComponent editorComponent { get; init; }

    [Parameter]
    public required Guid ModelId { get; init; }

    [Parameter]
    public required string CanvasId { get; init; }

    private RunDsmCommandCommandHandler runDsmCommandCommandHandler;
    private ReceiveFromSpeckleCommandHandler ReceiveFromSpeckleCommandHandler;
    private IState<AnalysisToolbarState> state;
    private IState<EditorComponentState> editorState;
    private IStructuralAnalysisApiClientV1 structuralAnalysisApiClientV1;
    private IDialogService dialogService;
    private ISpeckleConnectorApi speckleConnectorApi;
    private ISnackbar snackbar;
    private IDispatcher dispatcher;

    public AnalysisToolbar(
    RunDsmCommandCommandHandler runDsmCommandCommandHandler,
    ReceiveFromSpeckleCommandHandler receiveFromSpeckleCommandHandler,
    IState<AnalysisToolbarState> state,
    IStructuralAnalysisApiClientV1 structuralAnalysisApiClientV1,
    IDialogService dialogService,
    ISpeckleConnectorApi speckleConnectorApi,
    IState<EditorComponentState> editorState,
    ISnackbar snackbar,
    IDispatcher dispatcher)
    {
        this.runDsmCommandCommandHandler = runDsmCommandCommandHandler;
        this.ReceiveFromSpeckleCommandHandler = receiveFromSpeckleCommandHandler;
        this.state = state;
        this.structuralAnalysisApiClientV1 = structuralAnalysisApiClientV1;
        this.dialogService = dialogService;
        this.speckleConnectorApi = speckleConnectorApi;
        this.editorState = editorState;
        this.snackbar = snackbar;
        this.dispatcher = dispatcher;
    }

    private async Task RunAnalysis()
    {
        var result = await runDsmCommandCommandHandler.ExecuteAsync(new() { ModelId = this.ModelId, UnitsOverride = "kn-m" });

        if (result.IsSuccess)
        {
            await editorComponent.ShowDeflection();
        }
    }

    private async Task UnlockModel()
    {
        var result = await structuralAnalysisApiClientV1.DeleteAllResultSetsAsync(this.ModelId, CancellationToken.None);

        if (result.IsSuccess)
        {
            await editorState.Value.EditorApi.ClearCurrentOverlayAsync();
            dispatcher.Dispatch(new AnalyticalResultsCleared() { ModelId = this.ModelId });
        }
        else
        {
            snackbar.Add("You are not authorized to make changes to this model", Severity.Info);
        }
    }

    private async Task ReceiveFromSpeckle()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = dialogService.Show<ReceiveFromSpeckleDialog>("Receive Data From Speckle", options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var newToken = (SpeckleReceiveInfo)result.Data;
            var speckleToken = new SpeckleReceiveParameters
            (
            newToken.ApiToken,
            newToken.ProjectId,
            newToken.ObjectId,
            newToken.ServerUrl
            );

            await this.ReceiveFromSpeckleCommandHandler.ExecuteAsync(new ReceiveFromSpeckleCommand(this.CanvasId, this.ModelId,
            speckleToken));
        }
    }
    private List<ModelProposalInfo> modelProposals = new();
    private int selectedModelProposalId;
    private async Task GetModelProposals()
    {
        var result = await structuralAnalysisApiClientV1.GetModelProposalsAsync(this.ModelId, CancellationToken.None);

        if (result.IsSuccess)
        {
            modelProposals = result.Value;
        }
        else
        {
            snackbar.Add(result.Error.Description, Severity.Error);
        }
    }

    private async Task DisplayModelProposal(int selectedModelProposalId)
    {
        this.selectedModelProposalId = selectedModelProposalId;
        if (selectedModelProposalId == 0)
        {
            await editorState.Value.EditorApi.ClearModelProposalsAsync();
            return;
        }

        var modelProposal = await structuralAnalysisApiClientV1.GetModelProposalAsync(this.ModelId,
        selectedModelProposalId, CancellationToken.None);
        if (modelProposal.IsError)
        {
            throw new Exception(modelProposal.Error.Description);
        }

        await editorState.Value.EditorApi.ClearModelProposalsAsync();
        await editorState.Value.EditorApi.DisplayModelProposalAsync(modelProposal.Value);
    }

    private async Task AcceptModelProposal()
    {
        var result = await structuralAnalysisApiClientV1.AcceptModelProposalAsync(this.ModelId, this.selectedModelProposalId,
        CancellationToken.None);

        if (result.IsSuccess)
        {
            await editorState.Value.EditorApi.ClearCurrentOverlayAsync();
            this.selectedModelProposalId = 0;
        }
        else
        {
            snackbar.Add(result.Error.Description, Severity.Error);
        }
    }
    private async Task RejectModelProposal()
    {
        var result = await structuralAnalysisApiClientV1.RejectModelProposalAsync(this.ModelId, this.selectedModelProposalId,
        CancellationToken.None);

        if (result.IsSuccess)
        {
            await editorState.Value.EditorApi.ClearCurrentOverlayAsync();
            this.selectedModelProposalId = 0;
        }
        else
        {
            snackbar.Add(result.Error.Description, Severity.Error);
        }
    }

    [FeatureState]
    public record AnalysisToolbarState(bool IsCalculating)
    {
        public AnalysisToolbarState() : this(false)
        {

        }
    }

    public static class AnalysisToolbarStateReducers
    {
        [ReducerMethod]
        public static AnalysisToolbarState Reducer(AnalysisToolbarState state, AnalysisBegan analysisBegan)
        {
            return state with { IsCalculating = true };
        }

        [ReducerMethod]
        public static AnalysisToolbarState Reducer(AnalysisToolbarState state, AnalysisEnded analysisEnded)
        {
            return state with { IsCalculating = false };
        }
    }
}
